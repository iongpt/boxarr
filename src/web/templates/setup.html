<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Boxarr Setup{% endblock %}</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="setup-page">
    <div class="setup-container">
        <div class="setup-header">
            <h1 class="setup-title">üé¨ Welcome to Boxarr!</h1>
            <p class="setup-subtitle">Let's get you set up with your Radarr connection.</p>
        </div>
        

        <form id="setupForm">
            <!-- Radarr Connection Section -->
            <div class="form-section">
                <h2 class="section-title">Radarr Connection</h2>
                
                <div class="form-row two-col">
                    <div class="form-group">
                        <label for="radarrUrl" class="form-label">Radarr URL</label>
                        <input type="url" id="radarrUrl" name="radarr_url" class="form-input"
                               value="{{ radarr_url }}" 
                               placeholder="http://localhost:7878" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="radarrApiKey" class="form-label">Radarr API Key</label>
                        <input type="text" id="radarrApiKey" name="radarr_api_key" class="form-input"
                               value="{{ radarr_api_key }}" 
                               placeholder="Your Radarr API key" required>
                        <small class="text-muted">Found in Radarr ‚Üí Settings ‚Üí General ‚Üí Security</small>
                    </div>
                </div>
                
                <button type="button" class="btn btn-success btn-full" onclick="testConnection()">
                    <span id="testButtonText">Test Connection</span>
                    <span id="testButtonSpinner" class="loading-spinner" style="display: none;"></span>
                </button>
                
                <div id="testResults" class="test-results"></div>
            </div>

            <!-- Quality Settings Section -->
            <div id="qualitySection" class="form-section quality-section {% if is_configured %}show{% endif %}">
                <h2 class="section-title">Quality Settings</h2>
                
                <div class="form-group">
                    <label for="rootFolder" class="form-label">Root Folder</label>
                    <select id="rootFolder" name="radarr_root_folder" class="form-select" required>
                        <option value="">Select root folder...</option>
                        {% if is_configured and root_folder %}
                        <option value="{{ root_folder }}" selected>{{ root_folder }}</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-row two-col">
                    <div class="form-group">
                        <label for="defaultProfile" class="form-label">Default Quality Profile</label>
                        <select id="defaultProfile" name="radarr_quality_profile_default" class="form-select" required>
                            <option value="">Select default quality...</option>
                            {% if is_configured and quality_profile_default %}
                            <option value="{{ quality_profile_default }}" selected>{{ quality_profile_default }}</option>
                            {% endif %}
                        </select>
                        <small class="text-muted">Quality used when automatically adding new movies</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="upgradeProfile" class="form-label">Upgrade Quality Profile (Optional)</label>
                        <select id="upgradeProfile" name="radarr_quality_profile_upgrade" class="form-select">
                            <option value="">Select upgrade quality...</option>
                            {% if is_configured and quality_profile_upgrade %}
                            <option value="{{ quality_profile_upgrade }}" selected>{{ quality_profile_upgrade }}</option>
                            {% endif %}
                        </select>
                        <small class="text-muted">Higher quality option for manual upgrades</small>
                    </div>
                </div>
            </div>

            <!-- Automation Settings Section -->
            <div class="form-section">
                <h2 class="section-title">Automation Settings</h2>
                
                <div class="scheduler-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="schedulerEnabled" name="boxarr_scheduler_enabled" class="checkbox-input"
                               {% if scheduler_enabled %}checked{% endif %} onchange="toggleScheduler()">
                        <div>
                            <label for="schedulerEnabled" class="checkbox-label main">Enable Automatic Updates</label>
                            <div class="checkbox-label description">Automatically fetch new box office data</div>
                        </div>
                    </div>
                    
                    <div id="schedulerControls" class="scheduler-controls {% if scheduler_enabled %}active{% endif %}">
                        <div class="form-group">
                            <label for="schedulerDay" class="form-label">Update Day</label>
                            <select id="schedulerDay" class="form-select">
                                <option value="1" {% if scheduler_day == 1 %}selected{% endif %}>Monday</option>
                                <option value="2" {% if scheduler_day == 2 %}selected{% endif %}>Tuesday</option>
                                <option value="3" {% if scheduler_day == 3 %}selected{% endif %}>Wednesday</option>
                                <option value="4" {% if scheduler_day == 4 %}selected{% endif %}>Thursday</option>
                                <option value="5" {% if scheduler_day == 5 %}selected{% endif %}>Friday</option>
                                <option value="6" {% if scheduler_day == 6 %}selected{% endif %}>Saturday</option>
                                <option value="0" {% if scheduler_day == 0 %}selected{% endif %}>Sunday</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="schedulerTime" class="form-label">Update Time</label>
                            <select id="schedulerTime" class="form-select">
                                <option value="22" {% if scheduler_time == 22 %}selected{% endif %}>10:00 PM</option>
                                <option value="23" {% if scheduler_time == 23 %}selected{% endif %}>11:00 PM</option>
                                <option value="0" {% if scheduler_time == 0 %}selected{% endif %}>12:00 AM</option>
                                <option value="1" {% if scheduler_time == 1 %}selected{% endif %}>1:00 AM</option>
                                <option value="2" {% if scheduler_time == 2 %}selected{% endif %}>2:00 AM</option>
                                <option value="3" {% if scheduler_time == 3 %}selected{% endif %}>3:00 AM</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="autoAdd" name="boxarr_features_auto_add" class="checkbox-input"
                           {% if auto_add %}checked{% endif %}>
                    <div>
                        <label for="autoAdd" class="checkbox-label main">Auto-Add Missing Movies</label>
                        <div class="checkbox-label description">Automatically add unmatched movies to Radarr</div>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="qualityUpgrade" name="boxarr_features_quality_upgrade" class="checkbox-input"
                           {% if quality_upgrade %}checked{% endif %}>
                    <div>
                        <label for="qualityUpgrade" class="checkbox-label main">Quality Upgrade Buttons</label>
                        <div class="checkbox-label description">Show buttons to upgrade movie quality profiles</div>
                    </div>
                </div>
            </div>

            <div class="button-row">
                {% if is_configured %}
                <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
                {% else %}
                <div id="navigationSection" style="display: none;">
                    <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
                </div>
                {% endif %}
                
                <button type="submit" class="btn btn-primary btn-lg" id="saveBtn" disabled>
                    <span id="saveButtonText">Save Configuration</span>
                    <span id="saveButtonSpinner" class="loading-spinner" style="display: none;"></span>
                </button>
            </div>
            
            <div id="saveMessage"></div>
        </form>
    </div>

<script>
let connectionTested = false;

function toggleScheduler() {
    const checkbox = document.getElementById('schedulerEnabled');
    const controls = document.getElementById('schedulerControls');
    
    if (checkbox.checked) {
        controls.classList.add('active');
    } else {
        controls.classList.remove('active');
    }
}

function dayTimeToCron() {
    const day = document.getElementById('schedulerDay').value;
    const time = document.getElementById('schedulerTime').value;
    return `0 ${time} * * ${day}`;
}

async function testConnection() {
    const url = document.getElementById('radarrUrl').value;
    const apiKey = document.getElementById('radarrApiKey').value;
    
    if (!url || !apiKey) {
        showMessage('Please enter Radarr URL and API key', 'error');
        return;
    }
    
    const testBtn = document.querySelector('.btn-success');
    const textSpan = document.getElementById('testButtonText');
    const spinnerSpan = document.getElementById('testButtonSpinner');
    const resultsDiv = document.getElementById('testResults');
    
    testBtn.disabled = true;
    textSpan.textContent = 'Testing Connection...';
    spinnerSpan.style.display = 'inline-block';
    resultsDiv.classList.remove('show');
    
    try {
        const response = await fetch('/api/config/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url, api_key: apiKey })
        });
        
        const data = await response.json();
        
        if (data.success) {
            connectionTested = true;
            document.getElementById('saveBtn').disabled = false;
            
            resultsDiv.innerHTML = `
                <div class="status-message status-success">
                    <strong>‚úì Connection Successful!</strong>
                </div>
            `;
            resultsDiv.classList.add('show');
            
            // Show navigation section after successful connection
            const navSection = document.getElementById('navigationSection');
            if (navSection) navSection.style.display = 'block';
            
            // Populate quality profiles
            if (data.profiles && data.root_folders) {
                populateQualityProfiles(data.profiles, data.root_folders);
                document.getElementById('qualitySection').classList.add('show');
            }
        } else {
            connectionTested = false;
            document.getElementById('saveBtn').disabled = true;
            const navSection = document.getElementById('navigationSection');
            if (navSection) navSection.style.display = 'none';
            document.getElementById('qualitySection').classList.remove('show');
            
            resultsDiv.innerHTML = `
                <div class="status-message status-error">
                    <strong>‚úó Connection Failed</strong><br>
                    ${data.message || 'Unknown error occurred'}
                </div>
            `;
            resultsDiv.classList.add('show');
        }
    } catch (error) {
        connectionTested = false;
        document.getElementById('saveBtn').disabled = true;
        const navSection = document.getElementById('navigationSection');
        if (navSection) navSection.style.display = 'none';
        document.getElementById('qualitySection').classList.remove('show');
        
        resultsDiv.innerHTML = `
            <div class="status-message status-error">
                <strong>‚úó Connection Error</strong><br>
                ${error.message}
            </div>
        `;
        resultsDiv.classList.add('show');
    } finally {
        testBtn.disabled = false;
        textSpan.textContent = 'Test Connection';
        spinnerSpan.style.display = 'none';
    }
}

function populateQualityProfiles(profiles, rootFolders) {
    const defaultSelect = document.getElementById('defaultProfile');
    const upgradeSelect = document.getElementById('upgradeProfile');
    const rootSelect = document.getElementById('rootFolder');
    
    const currentDefaultProfile = '{{ quality_profile_default }}';
    const currentUpgradeProfile = '{{ quality_profile_upgrade }}';
    const currentRootFolder = '{{ root_folder }}';
    
    // Store current selections before clearing
    const tempDefaultValue = defaultSelect.value || currentDefaultProfile;
    const tempUpgradeValue = upgradeSelect.value || currentUpgradeProfile;
    const tempRootValue = rootSelect.value || currentRootFolder;
    
    // Clear and rebuild options
    defaultSelect.innerHTML = '<option value="">Select default quality...</option>';
    upgradeSelect.innerHTML = '<option value="">No upgrade (optional)</option>';
    rootSelect.innerHTML = '<option value="">Select root folder...</option>';
    
    // Add all quality profiles from Radarr
    if (profiles && profiles.length > 0) {
        profiles.forEach(profile => {
            // Add to default quality dropdown
            const defaultOption = new Option(profile.name, profile.name);
            if (profile.name === tempDefaultValue) {
                defaultOption.selected = true;
            }
            defaultSelect.add(defaultOption);
            
            // Add to upgrade quality dropdown
            const upgradeOption = new Option(profile.name, profile.name);
            if (profile.name === tempUpgradeValue) {
                upgradeOption.selected = true;
            }
            upgradeSelect.add(upgradeOption);
        });
    }
    
    // Add all root folders
    if (rootFolders && rootFolders.length > 0) {
        rootFolders.forEach(folder => {
            const freeSpaceGB = folder.freeSpace ? Math.round(folder.freeSpace / 1073741824 * 10) / 10 : 0;
            const displayText = freeSpaceGB > 0 
                ? `${folder.path} (${freeSpaceGB} GB free)`
                : folder.path;
            
            const option = new Option(displayText, folder.path);
            
            // Pre-select current root folder
            if (folder.path === tempRootValue) {
                option.selected = true;
            }
            
            rootSelect.add(option);
        });
    }
}

function showMessage(message, type) {
    const messageDiv = document.getElementById('saveMessage');
    messageDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
}

document.getElementById('setupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!connectionTested) {
        showMessage('Please test the Radarr connection before saving configuration.', 'error');
        return;
    }
    
    // Additional validation for required fields
    const url = document.getElementById('radarrUrl').value;
    const apiKey = document.getElementById('radarrApiKey').value;
    const rootFolder = document.getElementById('rootFolder').value;
    const defaultProfile = document.getElementById('defaultProfile').value;
    
    if (!url || !apiKey) {
        showMessage('Radarr URL and API Key are required.', 'error');
        return;
    }
    
    if (!rootFolder || !defaultProfile) {
        showMessage('Please select root folder and default quality profile.', 'error');
        return;
    }
    
    const formData = new FormData(e.target);
    const config = {};
    
    // Convert form data to object
    for (let [key, value] of formData.entries()) {
        config[key] = value;
    }
    
    // Add checkboxes (they don't appear in FormData if unchecked)
    config.boxarr_scheduler_enabled = document.getElementById('schedulerEnabled').checked;
    config.boxarr_features_auto_add = document.getElementById('autoAdd').checked;
    config.boxarr_features_quality_upgrade = document.getElementById('qualityUpgrade').checked;
    
    // Convert day/time to cron if scheduler is enabled
    if (config.boxarr_scheduler_enabled) {
        config.boxarr_scheduler_cron = dayTimeToCron();
    }
    
    const saveBtn = document.getElementById('saveBtn');
    const textSpan = document.getElementById('saveButtonText');
    const spinnerSpan = document.getElementById('saveButtonSpinner');
    
    saveBtn.disabled = true;
    textSpan.textContent = 'Saving Configuration...';
    spinnerSpan.style.display = 'inline-block';
    
    try {
        const response = await fetch('/api/config/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('‚úì Configuration saved successfully! Redirecting...', 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            showMessage(`‚úó Save failed: ${data.message}`, 'error');
            saveBtn.disabled = false;
            textSpan.textContent = 'Save Configuration';
            spinnerSpan.style.display = 'none';
        }
    } catch (error) {
        showMessage(`‚úó Error: ${error.message}`, 'error');
        saveBtn.disabled = false;
        textSpan.textContent = 'Save Configuration';
        spinnerSpan.style.display = 'none';
    }
});

// Reset connection test when credentials change
function resetConnectionTest() {
    connectionTested = false;
    document.getElementById('saveBtn').disabled = true;
    const navSection = document.getElementById('navigationSection');
    if (navSection) navSection.style.display = 'none';
    document.getElementById('qualitySection').classList.remove('show');
    document.getElementById('testResults').classList.remove('show');
}

// Initialize on load
window.addEventListener('load', () => {
    // Add input listeners to reset connection test when credentials change
    document.getElementById('radarrUrl').addEventListener('input', resetConnectionTest);
    document.getElementById('radarrApiKey').addEventListener('input', resetConnectionTest);
    
    // Check if we have existing valid credentials and auto-test connection
    const url = document.getElementById('radarrUrl').value;
    const apiKey = document.getElementById('radarrApiKey').value;
    const isConfigured = {{ 'true' if is_configured else 'false' }};
    
    // If app is already configured and has credentials, auto-test connection
    if (isConfigured && url && apiKey && apiKey.trim().length > 10) {
        // Mark as already tested since we're configured
        connectionTested = true;
        document.getElementById('saveBtn').disabled = false;
        
        // Auto-test to refresh quality profiles and root folders
        setTimeout(() => {
            testConnection();
        }, 500);  // Small delay to let page finish loading
    } else if (!isConfigured) {
        // For first-time setup, ensure save button is disabled until connection tested
        document.getElementById('saveBtn').disabled = true;
    }
});
</script>
</body>
</html>