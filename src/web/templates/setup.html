<!DOCTYPE html>
<html lang="en" data-server-theme="{{ theme|default('light') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Boxarr Setup{% endblock %}</title>
    <link rel="stylesheet" href="{{ request.scope.get('root_path', '') }}/static/css/style.css">
    <script>
        // Apply theme immediately to prevent flash
        (function() {
            const stored = localStorage.getItem('boxarr-theme-preference');
            let theme = stored || '{{ theme|default("light") }}';
            
            if (theme === 'auto') {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body class="setup-page">
    <script>
        // Inject base path for JavaScript usage
        window.BOXARR_BASE_PATH = "{{ request.scope.get('root_path', '') }}";
    </script>
    <div class="setup-container">
        <div class="setup-header">
            <h1 class="setup-title">🎬 Welcome to Boxarr!</h1>
            <p class="setup-subtitle">Let's get you set up with your Radarr connection.</p>
        </div>
        

        <form id="setupForm">
            <!-- Radarr Connection Section -->
            <div class="form-section">
                <h2 class="section-title">Radarr Connection</h2>
                
                <div class="form-row two-col">
                    <div class="form-group">
                        <label for="radarrUrl" class="form-label">Radarr URL</label>
                        <input type="url" id="radarrUrl" name="radarr_url" class="form-input"
                               value="{{ radarr_url }}" 
                               placeholder="http://localhost:7878" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="radarrApiKey" class="form-label">Radarr API Key</label>
                        <input type="text" id="radarrApiKey" name="radarr_api_key" class="form-input"
                               value="{{ radarr_api_key }}" 
                               placeholder="Your Radarr API key" required>
                        <small class="text-muted">Found in Radarr → Settings → General → Security</small>
                    </div>
                </div>
                
                <button type="button" class="btn btn-success btn-full" onclick="testConnection()">
                    <span id="testButtonText">Test Connection</span>
                    <span id="testButtonSpinner" class="loading-spinner" style="display: none;"></span>
                </button>
                
                <div id="testResults" class="test-results"></div>
            </div>

            <!-- Quality Settings Section -->
            <div id="qualitySection" class="form-section quality-section {% if is_configured %}show{% endif %}">
                <h2 class="section-title">Quality Settings</h2>
                
                <div class="form-group">
                    <label for="rootFolder" class="form-label">Root Folder</label>
                    <select id="rootFolder" name="radarr_root_folder" class="form-select" required>
                        <option value="">Select root folder...</option>
                        {% if is_configured and root_folder %}
                        <option value="{{ root_folder }}" selected>{{ root_folder }}</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-row two-col">
                    <div class="form-group">
                        <label for="defaultProfile" class="form-label">Default Quality Profile</label>
                        <select id="defaultProfile" name="radarr_quality_profile_default" class="form-select" required>
                            <option value="">Select default quality...</option>
                            {% if is_configured and quality_profile_default %}
                            <option value="{{ quality_profile_default }}" selected>{{ quality_profile_default }}</option>
                            {% endif %}
                        </select>
                        <small class="text-muted">Quality used when automatically adding new movies</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="upgradeProfile" class="form-label">Upgrade Quality Profile (Optional)</label>
                        <select id="upgradeProfile" name="radarr_quality_profile_upgrade" class="form-select">
                            <option value="">Select upgrade quality...</option>
                            {% if is_configured and quality_profile_upgrade %}
                            <option value="{{ quality_profile_upgrade }}" selected>{{ quality_profile_upgrade }}</option>
                            {% endif %}
                        </select>
                        <small class="text-muted">Higher quality option for manual upgrades</small>
                    </div>
                </div>
            </div>

            

            

            <!-- Automation Settings Section -->
            <div class="form-section">
                <h2 class="section-title">Automation Settings</h2>
                
                <div class="scheduler-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="schedulerEnabled" name="boxarr_scheduler_enabled" class="checkbox-input"
                               {% if scheduler_enabled %}checked{% endif %} onchange="toggleScheduler()">
                        <div>
                            <label for="schedulerEnabled" class="checkbox-label main">Enable Automatic Updates</label>
                            <div class="checkbox-label description">Automatically fetch new box office data</div>
                        </div>
                    </div>
                    
                    <div id="schedulerControls" class="scheduler-controls {% if scheduler_enabled %}active{% endif %}">
                        <div class="form-group">
                            <label for="schedulerDay" class="form-label">Update Day</label>
                            <select id="schedulerDay" class="form-select">
                                <option value="1" {% if scheduler_day == 1 %}selected{% endif %}>Monday</option>
                                <option value="2" {% if scheduler_day == 2 %}selected{% endif %}>Tuesday</option>
                                <option value="3" {% if scheduler_day == 3 %}selected{% endif %}>Wednesday</option>
                                <option value="4" {% if scheduler_day == 4 %}selected{% endif %}>Thursday</option>
                                <option value="5" {% if scheduler_day == 5 %}selected{% endif %}>Friday</option>
                                <option value="6" {% if scheduler_day == 6 %}selected{% endif %}>Saturday</option>
                                <option value="0" {% if scheduler_day == 0 %}selected{% endif %}>Sunday</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="schedulerTime" class="form-label">Update Time</label>
                            <select id="schedulerTime" class="form-select">
                                <option value="22" {% if scheduler_time == 22 %}selected{% endif %}>10:00 PM</option>
                                <option value="23" {% if scheduler_time == 23 %}selected{% endif %}>11:00 PM</option>
                                <option value="0" {% if scheduler_time == 0 %}selected{% endif %}>12:00 AM</option>
                                <option value="1" {% if scheduler_time == 1 %}selected{% endif %}>1:00 AM</option>
                                <option value="2" {% if scheduler_time == 2 %}selected{% endif %}>2:00 AM</option>
                                <option value="3" {% if scheduler_time == 3 %}selected{% endif %}>3:00 AM</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="autoAdd" name="boxarr_features_auto_add" class="checkbox-input"
                           {% if auto_add %}checked{% endif %} onchange="toggleAutoAddOptions()">
                    <div>
                        <label for="autoAdd" class="checkbox-label main">Auto-Add Missing Movies</label>
                        <div class="checkbox-label description">Automatically add unmatched movies to Radarr</div>
                    </div>
                </div>
                
                <!-- Auto-Add Advanced Options -->
                <div id="autoAddOptions" class="auto-add-options {% if auto_add %}active{% endif %}" style="margin-left: 2rem; margin-top: 1rem; padding: 1rem; background: var(--bg-color); border-radius: 8px; border-left: 3px solid var(--primary-color);">
                    <!-- Top X Movies Limit -->
                    <div class="form-group">
                        <label for="autoAddLimit" class="form-label">Maximum Movies to Add</label>
                        <select id="autoAddLimit" name="boxarr_features_auto_add_limit" class="form-select">
                            {% for i in range(1, 11) %}
                            <option value="{{ i }}" {% if auto_add_limit == i %}selected{% endif %}>{{ i }} movie{% if i > 1 %}s{% endif %}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Only add the top X movies from the box office rankings</small>
                    </div>
                    
                    <!-- Genre Filter -->
                    <div class="filter-section" style="margin-top: 1.5rem;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="genreFilterEnabled" name="boxarr_features_auto_add_genre_filter_enabled" 
                                   class="checkbox-input" {% if genre_filter_enabled %}checked{% endif %} onchange="toggleGenreFilter()">
                            <div>
                                <label for="genreFilterEnabled" class="checkbox-label main">Enable Genre Filter</label>
                                <div class="checkbox-label description">Filter movies by genre before adding</div>
                            </div>
                        </div>
                        
                        <div id="genreFilterOptions" class="filter-options {% if genre_filter_enabled %}active{% endif %}" style="margin-top: 0.5rem;">
                            <div class="form-group">
                                <label class="form-label">Filter Mode</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="boxarr_features_auto_add_genre_filter_mode" value="whitelist" 
                                               {% if genre_filter_mode == 'whitelist' %}checked{% endif %} onchange="updateGenreMode()">
                                        <span>Whitelist - Only add movies with selected genres</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="boxarr_features_auto_add_genre_filter_mode" value="blacklist" 
                                               {% if genre_filter_mode == 'blacklist' %}checked{% endif %} onchange="updateGenreMode()">
                                        <span>Blacklist - Exclude movies with selected genres</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" id="genreListLabel">
                                    {% if genre_filter_mode == 'whitelist' %}Allowed Genres{% else %}Excluded Genres{% endif %}
                                </label>
                                <div class="genre-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem;">
                                    {% set common_genres = ['Action', 'Adventure', 'Animation', 'Comedy', 'Crime', 'Documentary', 
                                                           'Drama', 'Family', 'Fantasy', 'History', 'Horror', 'Music', 
                                                           'Mystery', 'Romance', 'Science Fiction', 'TV Movie', 'Thriller', 'War', 'Western'] %}
                                    {% for genre in common_genres %}
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" name="genre_{{ genre | replace(' ', '_') }}" value="{{ genre }}"
                                               data-genre-whitelist="{% if genre in genre_whitelist %}true{% else %}false{% endif %}"
                                               data-genre-blacklist="{% if genre in genre_blacklist %}true{% else %}false{% endif %}"
                                               {% if (genre_filter_mode == 'whitelist' and genre in genre_whitelist) or (genre_filter_mode == 'blacklist' and genre in genre_blacklist) %}checked{% endif %}>
                                        <span>{{ genre }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Age Rating Filter -->
                    <div class="filter-section" style="margin-top: 1.5rem;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="ratingFilterEnabled" name="boxarr_features_auto_add_rating_filter_enabled" 
                                   class="checkbox-input" {% if rating_filter_enabled %}checked{% endif %} onchange="toggleRatingFilter()">
                            <div>
                                <label for="ratingFilterEnabled" class="checkbox-label main">Enable Age Rating Filter</label>
                                <div class="checkbox-label description">Only add movies with specific age ratings</div>
                            </div>
                        </div>
                        
                        <div id="ratingFilterOptions" class="filter-options {% if rating_filter_enabled %}active{% endif %}" style="margin-top: 0.5rem;">
                            <div class="form-group">
                                <label class="form-label">Allowed Age Ratings</label>
                                <div class="rating-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem;">
                                    {% set common_ratings = ['G', 'PG', 'PG-13', 'R', 'NC-17', 'NR'] %}
                                    {% for rating in common_ratings %}
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" name="rating_{{ rating | replace('-', '_') }}" value="{{ rating }}"
                                               {% if rating in rating_whitelist %}checked{% endif %}>
                                        <span>{{ rating }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                                <small class="text-muted">Note: Some movies may not have rating information available</small>
                            </div>
                        </div>
                    </div>

                    <!-- Ignore Re-releases -->
                    <div class="filter-section" style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="ignoreRereleasesEnabled" name="boxarr_features_auto_add_ignore_rereleases"
                                   class="checkbox-input" {% if ignore_rereleases %}checked{% endif %}>
                            <div>
                                <label for="ignoreRereleasesEnabled" class="checkbox-label main">Ignore Re-releases</label>
                                <div class="checkbox-label description">
                                    Skip older movies when adding from past weeks. Only adds movies released in the selected year or the previous year.
                                    For example, when fetching week 15 of 2021, only movies from 2020-2021 will be added.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="qualityUpgrade" name="boxarr_features_quality_upgrade" class="checkbox-input"
                           {% if quality_upgrade %}checked{% endif %}>
                    <div>
                        <label for="qualityUpgrade" class="checkbox-label main">Quality Upgrade Buttons</label>
                        <div class="checkbox-label description">Show buttons to upgrade movie quality profiles</div>
                    </div>
                </div>
            </div>

            <!-- Scheduler Debug Section (Collapsible) -->
            {% if is_configured %}
            <div class="form-section scheduler-debug-section">
                <h2 class="section-title collapsible" onclick="toggleSchedulerDebug()">
                    <span class="collapse-icon">▶</span> Scheduler Debug
                    <span id="schedulerStatusBadge" class="status-badge"></span>
                </h2>
                
                <div id="schedulerDebugContent" class="scheduler-debug-content" style="display: none;">
                    <div class="debug-info">
                        <div class="debug-row">
                            <span class="debug-label">Service Status:</span>
                            <span id="debugServiceStatus" class="debug-value">Loading...</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">Next Run:</span>
                            <span id="debugNextRun" class="debug-value">Loading...</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">Last Run:</span>
                            <span id="debugLastRun" class="debug-value">Loading...</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">Active Jobs:</span>
                            <span id="debugActiveJobs" class="debug-value">Loading...</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">Timezone:</span>
                            <span id="debugTimezone" class="debug-value">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="debug-actions">
                        <button type="button" class="btn btn-sm btn-success" onclick="triggerScheduler()">
                            ▶ Trigger Now
                        </button>
                        <button type="button" class="btn btn-sm btn-warning" onclick="reloadScheduler()">
                            🔄 Reload
                        </button>
                        <button type="button" class="btn btn-sm btn-info" onclick="refreshSchedulerStatus()">
                            🔍 Refresh Status
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- UI Settings Section -->
            <div class="form-section">
                <h2 class="section-title">UI Settings</h2>
                <div class="form-group">
                    <label for="uiTheme" class="form-label">Theme</label>
                    <select name="boxarr_ui_theme" id="uiTheme" class="form-select" onchange="if(window.themeManager) themeManager.setTheme(this.value)">
                        <option value="light" {% if theme == 'light' or theme == 'purple' or theme == 'blue' %}selected{% endif %}>☀️ Light</option>
                        <option value="dark" {% if theme == 'dark' %}selected{% endif %}>🌙 Dark</option>
                        <option value="auto" {% if theme == 'auto' %}selected{% endif %}>💻 Follow System</option>
                    </select>
                    <small class="text-muted">Choose your preferred theme or let it follow your system settings</small>
                </div>
            </div>

            <!-- Advanced Settings (collapsible, default closed). Add margin-top and place right above buttons. -->
            <div class="form-section" id="advancedSettingsSection" style="margin-top: 2rem;">
                <div style="display:flex; align-items:center; justify-content:space-between; cursor:pointer;"
                     onclick="(function(){ const s=document.getElementById('advancedSettingsContent'); const i=document.getElementById('advancedSettingsChevron'); if(s.style.display==='none'){s.style.display='block'; i.textContent='▾';} else {s.style.display='none'; i.textContent='▸';}})()">
                    <h2 class="section-title" style="margin:0;">Advanced Settings</h2>
                    <span id="advancedSettingsChevron" aria-hidden="true">▸</span>
                </div>
                <div id="advancedSettingsContent" style="display:none; margin-top:1rem;">
                    <!-- Genre-Based Root Folders section moved here -->
                    <div id="rootFolderMappingSection" class="form-section">
                        <h3 class="section-title">Genre-Based Root Folders (Optional)</h3>
                        <p class="text-muted" style="margin-bottom: 1rem;">Automatically organize movies into different folders based on their genres.</p>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="rootFolderMappingEnabled" name="root_folder_mapping_enabled" class="checkbox-input"
                                   {% if root_folder_mapping_enabled %}checked{% endif %}
                                   onchange="toggleRootFolderMapping()">
                            <div>
                                <label for="rootFolderMappingEnabled" class="checkbox-label main">Enable Genre-Based Organization</label>
                                <div class="checkbox-label description">Movies will be automatically placed in folders based on their genres</div>
                            </div>
                        </div>

                        <div id="rootFolderMappingControls" style="display: {% if root_folder_mapping_enabled %}block{% else %}none{% endif %}; margin-top: 1.5rem;">
                            <!-- Add New Rule Widget -->
                            <div style="background: var(--bg-secondary); padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                                <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1rem; font-weight: 600;">Add New Rule</h4>
                                <div style="display: grid; grid-template-columns: 2fr 2fr auto; gap: 0.75rem; align-items: end;">
                                    <div>
                                        <label class="form-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 0.5rem; display: block;">Select Genres</label>
                                        <select id="newMappingGenres" multiple style="width: 100%; min-height: 42px; padding: 0.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem;">
                                            {% set common_genres = ['Action', 'Adventure', 'Animation', 'Comedy', 'Crime', 'Documentary', 
                                                                   'Drama', 'Family', 'Fantasy', 'History', 'Horror', 'Music', 
                                                                   'Mystery', 'Romance', 'Science Fiction', 'TV Movie', 'Thriller', 'War', 'Western'] %}
                                            {% for genre in common_genres %}
                                            <option value="{{ genre }}">{{ genre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 0.5rem; display: block;">Target Folder</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <select id="newMappingFolder" style="width: 100%; padding: 0.625rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem;">
                                                <option value="">Select folder...</option>
                                            </select>
                                            <button type="button" class="btn btn-sm" title="Refresh folders" aria-label="Refresh folders" onclick="refreshRootFolders()" style="padding: 0.625rem; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; transition: all 0.2s; cursor: pointer;">↻</button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="addRootFolderMapping()" style="padding: 0.625rem 1.25rem; border-radius: 6px; font-weight: 500;">
                                        + Add Rule
                                    </button>
                                </div>
                                <div style="margin-top: 0.75rem; padding: 0.5rem 0.75rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.8rem; color: var(--text-muted);">
                                    💡 <strong>Tip:</strong> Select multiple genres by holding Ctrl (Windows/Linux) or Cmd (Mac) while clicking
                                </div>
                            </div>

                            <!-- Existing Rules List -->
                            <div style="background: var(--bg-secondary); padding: 1.25rem; border-radius: 8px; border: 1px solid var(--border-color);">
                                <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1rem; font-weight: 600;">Active Rules</h4>
                                <div id="mappingsList">
                                    {% if root_folder_mappings and root_folder_mappings|length > 0 %}
                                        <!-- This is temporary display, will be replaced by JavaScript -->
                                        <div style="display: grid; grid-template-columns: 2fr auto 2fr 100px 120px; gap: 1rem; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); border-bottom: 1px solid var(--border-color);">
                                            <div title="Rules are applied from top to bottom">Genres</div>
                                            <div></div>
                                            <div>Target Folder</div>
                                            <div title="Order index (top to bottom)">Priority</div>
                                            <div style="text-align: center;">Actions</div>
                                        </div>
                                        {% for m in root_folder_mappings %}
                                        <div class="mapping-rule" style="display: grid; grid-template-columns: 2fr auto 2fr 100px 120px; gap: 1rem; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px;">
                                            <div style="font-weight: 500; color: var(--text-primary);">{{ m.genres|join(', ') }}</div>
                                            <div style="color: var(--text-muted); text-align: center;">→</div>
                                            <div style="color: var(--primary-color);">{{ m.root_folder }}</div>
                                            <div>
                                                <span style="display: inline-block; padding: 0.25rem 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;">{{ m.priority }}</span>
                                            </div>
                                            <div style="text-align: center; color: var(--text-muted);">
                                                <!-- Actions will be added by JavaScript -->
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="empty-state" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                            No rules configured yet. Add your first rule above!
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Help Text -->
                            <div class="alert" style="margin-top: 1rem; padding: 12px; background: var(--bg-tertiary); color: var(--text-primary); border-left: 3px solid var(--primary-color); border-radius: 4px;">
                                <strong>ℹ️ How it works:</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 0.9rem;">
                                    <li>When adding a movie, Boxarr checks its genres against your rules from <em>top to bottom</em></li>
                                    <li>The <strong>first matching rule</strong> wins; remaining rules are not evaluated</li>
                                    <li>Movies without matching genres use the default root folder</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- URL Base (Reverse Proxy) -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label for="urlBase" class="form-label">URL Base (for Reverse Proxy)</label>
                        <input type="text" id="urlBase" class="form-input"
                               value="{{ url_base|default('') }}"
                               readonly
                               style="background-color: var(--bg-secondary); opacity: 0.7; cursor: not-allowed;">

                        <div class="alert" style="margin-top: 10px; padding: 12px; background: var(--bg-info); color: var(--text-primary); border-left: 3px solid var(--primary-color); border-radius: 4px;">
                            <strong>ℹ️ Current URL Base:</strong>
                            {% if url_base %}
                                <code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px; color: var(--text-primary);">/{{ url_base }}/</code>
                                – The app is accessible at
                                <code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px; color: var(--text-primary);">http://your-server/{{ url_base }}/</code>
                            {% else %}
                                <code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px; color: var(--text-primary);">/</code>
                                (root) – The app is accessible at
                                <code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px; color: var(--text-primary);">http://your-server/</code>
                            {% endif %}
                        </div>

                        <div style="margin-top: 10px; padding: 12px; background: var(--bg-secondary); color: var(--text-primary); border-radius: 4px; border: 1px solid var(--border-color);">
                            <strong>📝 How to Configure:</strong>
                            <p style="margin: 8px 0; color: var(--text-secondary);">
                                To run Boxarr behind a reverse proxy, set the
                                <code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px; color: var(--text-primary);">BOXARR_URL_BASE</code>
                                environment variable:
                            </p>

                            <div style="background: var(--bg-tertiary); color: var(--text-primary); padding: 10px; border-radius: 4px; margin: 8px 0; font-family: monospace; font-size: 0.9em; border: 1px solid var(--border-color);">
                                <div style="color: var(--text-muted);"># Docker Compose:</div>
                                <div>environment:</div>
                                <div>&nbsp;&nbsp;- BOXARR_URL_BASE=boxarr</div>
                            </div>

                            <div style="background: var(--bg-tertiary); color: var(--text-primary); padding: 10px; border-radius: 4px; margin: 8px 0; font-family: monospace; font-size: 0.9em; border: 1px solid var(--border-color);">
                                <div style="color: var(--text-muted);"># Command line:</div>
                                <div>BOXARR_URL_BASE=boxarr python -m src.main</div>
                            </div>

                            <small class="text-muted">Do not include leading or trailing slashes. After setting, restart Boxarr to apply changes.</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-row" style="margin-top: 1.5rem;">
                {% if is_configured %}
                <a href="{{ request.scope.get('root_path', '') }}/" class="btn btn-secondary">← Back to Dashboard</a>
                {% else %}
                <div id="navigationSection" style="display: none;">
                    <a href="{{ request.scope.get('root_path', '') }}/" class="btn btn-secondary">← Back to Dashboard</a>
                </div>
                {% endif %}
                
                <button type="submit" class="btn btn-primary btn-lg" id="saveBtn" disabled>
                    <span id="saveButtonText">Save Configuration</span>
                    <span id="saveButtonSpinner" class="loading-spinner" style="display: none;"></span>
                </button>
            </div>
            
            <div id="saveMessage"></div>


        </form>
    </div>

<script src="{{ request.scope.get('root_path', '') }}/static/js/theme-manager.js?v=1"></script>
<script src="{{ request.scope.get('root_path', '') }}/static/js/app.js?v=2"></script>
<script>
// Sync theme select with current preference
document.addEventListener('DOMContentLoaded', function() {
    if (window.themeManager) {
        const preference = themeManager.getPreference();
        const themeSelect = document.getElementById('uiTheme');
        if (themeSelect && preference) {
            themeSelect.value = preference;
        }
    }
    
    // Initialize root folder mappings from server data
    {% if root_folder_mappings %}
    window.rootFolderMappings = [
        {% for mapping in root_folder_mappings %}
        {
            id: {{ loop.index }},
            genres: {{ mapping.genres | tojson }},
            root_folder: {{ mapping.root_folder | tojson }},
            priority: {{ mapping.priority }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    window.mappingIdCounter = {{ root_folder_mappings|length }};
    
    // Store original config to detect changes
    window.originalRootFolderConfig = {
        enabled: {{ root_folder_mapping_enabled|lower }},
        mappings: JSON.parse(JSON.stringify(window.rootFolderMappings))
    };
    
    // Load available root folders and render existing mappings
    if (document.getElementById('rootFolderMappingEnabled')?.checked) {
        window.loadAvailableRootFolders();
        window.renderMappingsList();
    }
    {% else %}
    // No existing mappings, but initialize empty arrays
    window.rootFolderMappings = [];
    window.mappingIdCounter = 0;
    window.originalRootFolderConfig = {
        enabled: {{ root_folder_mapping_enabled|lower }},
        mappings: []
    };
    {% endif %}
});
</script>
</body>
</html>
