<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Boxarr Setup{% endblock %}</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="setup-page">
    <div class="setup-container">
        <div class="setup-header">
            <h1 class="setup-title">🎬 Welcome to Boxarr!</h1>
            <p class="setup-subtitle">Let's get you set up with your Radarr connection.</p>
        </div>
        

        <form id="setupForm">
            <!-- Radarr Connection Section -->
            <div class="form-section">
                <h2 class="section-title">Radarr Connection</h2>
                
                <div class="form-row two-col">
                    <div class="form-group">
                        <label for="radarrUrl" class="form-label">Radarr URL</label>
                        <input type="url" id="radarrUrl" name="radarr_url" class="form-input"
                               value="{{ radarr_url }}" 
                               placeholder="http://localhost:7878" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="radarrApiKey" class="form-label">Radarr API Key</label>
                        <input type="text" id="radarrApiKey" name="radarr_api_key" class="form-input"
                               value="{{ radarr_api_key }}" 
                               placeholder="Your Radarr API key" required>
                        <small class="text-muted">Found in Radarr → Settings → General → Security</small>
                    </div>
                </div>
                
                <button type="button" class="btn btn-success btn-full" onclick="testConnection()">
                    <span id="testButtonText">Test Connection</span>
                    <span id="testButtonSpinner" class="loading-spinner" style="display: none;"></span>
                </button>
                
                <div id="testResults" class="test-results"></div>
            </div>

            <!-- Quality Settings Section -->
            <div id="qualitySection" class="form-section quality-section {% if is_configured %}show{% endif %}">
                <h2 class="section-title">Quality Settings</h2>
                
                <div class="form-group">
                    <label for="rootFolder" class="form-label">Root Folder</label>
                    <select id="rootFolder" name="radarr_root_folder" class="form-select" required>
                        <option value="">Select root folder...</option>
                        {% if is_configured and root_folder %}
                        <option value="{{ root_folder }}" selected>{{ root_folder }}</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-row two-col">
                    <div class="form-group">
                        <label for="defaultProfile" class="form-label">Default Quality Profile</label>
                        <select id="defaultProfile" name="radarr_quality_profile_default" class="form-select" required>
                            <option value="">Select default quality...</option>
                            {% if is_configured and quality_profile_default %}
                            <option value="{{ quality_profile_default }}" selected>{{ quality_profile_default }}</option>
                            {% endif %}
                        </select>
                        <small class="text-muted">Quality used when automatically adding new movies</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="upgradeProfile" class="form-label">Upgrade Quality Profile (Optional)</label>
                        <select id="upgradeProfile" name="radarr_quality_profile_upgrade" class="form-select">
                            <option value="">Select upgrade quality...</option>
                            {% if is_configured and quality_profile_upgrade %}
                            <option value="{{ quality_profile_upgrade }}" selected>{{ quality_profile_upgrade }}</option>
                            {% endif %}
                        </select>
                        <small class="text-muted">Higher quality option for manual upgrades</small>
                    </div>
                </div>
            </div>

            <!-- Automation Settings Section -->
            <div class="form-section">
                <h2 class="section-title">Automation Settings</h2>
                
                <div class="scheduler-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="schedulerEnabled" name="boxarr_scheduler_enabled" class="checkbox-input"
                               {% if scheduler_enabled %}checked{% endif %} onchange="toggleScheduler()">
                        <div>
                            <label for="schedulerEnabled" class="checkbox-label main">Enable Automatic Updates</label>
                            <div class="checkbox-label description">Automatically fetch new box office data</div>
                        </div>
                    </div>
                    
                    <div id="schedulerControls" class="scheduler-controls {% if scheduler_enabled %}active{% endif %}">
                        <div class="form-group">
                            <label for="schedulerDay" class="form-label">Update Day</label>
                            <select id="schedulerDay" class="form-select">
                                <option value="1" {% if scheduler_day == 1 %}selected{% endif %}>Monday</option>
                                <option value="2" {% if scheduler_day == 2 %}selected{% endif %}>Tuesday</option>
                                <option value="3" {% if scheduler_day == 3 %}selected{% endif %}>Wednesday</option>
                                <option value="4" {% if scheduler_day == 4 %}selected{% endif %}>Thursday</option>
                                <option value="5" {% if scheduler_day == 5 %}selected{% endif %}>Friday</option>
                                <option value="6" {% if scheduler_day == 6 %}selected{% endif %}>Saturday</option>
                                <option value="0" {% if scheduler_day == 0 %}selected{% endif %}>Sunday</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="schedulerTime" class="form-label">Update Time</label>
                            <select id="schedulerTime" class="form-select">
                                <option value="22" {% if scheduler_time == 22 %}selected{% endif %}>10:00 PM</option>
                                <option value="23" {% if scheduler_time == 23 %}selected{% endif %}>11:00 PM</option>
                                <option value="0" {% if scheduler_time == 0 %}selected{% endif %}>12:00 AM</option>
                                <option value="1" {% if scheduler_time == 1 %}selected{% endif %}>1:00 AM</option>
                                <option value="2" {% if scheduler_time == 2 %}selected{% endif %}>2:00 AM</option>
                                <option value="3" {% if scheduler_time == 3 %}selected{% endif %}>3:00 AM</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="autoAdd" name="boxarr_features_auto_add" class="checkbox-input"
                           {% if auto_add %}checked{% endif %} onchange="toggleAutoAddOptions()">
                    <div>
                        <label for="autoAdd" class="checkbox-label main">Auto-Add Missing Movies</label>
                        <div class="checkbox-label description">Automatically add unmatched movies to Radarr</div>
                    </div>
                </div>
                
                <!-- Auto-Add Advanced Options -->
                <div id="autoAddOptions" class="auto-add-options {% if auto_add %}active{% endif %}" style="margin-left: 2rem; margin-top: 1rem; padding: 1rem; background: var(--bg-color); border-radius: 8px; border-left: 3px solid var(--primary-color);">
                    <!-- Top X Movies Limit -->
                    <div class="form-group">
                        <label for="autoAddLimit" class="form-label">Maximum Movies to Add</label>
                        <select id="autoAddLimit" name="boxarr_features_auto_add_limit" class="form-select">
                            {% for i in range(1, 11) %}
                            <option value="{{ i }}" {% if auto_add_limit == i %}selected{% endif %}>{{ i }} movie{% if i > 1 %}s{% endif %}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Only add the top X movies from the box office rankings</small>
                    </div>
                    
                    <!-- Genre Filter -->
                    <div class="filter-section" style="margin-top: 1.5rem;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="genreFilterEnabled" name="boxarr_features_auto_add_genre_filter_enabled" 
                                   class="checkbox-input" {% if genre_filter_enabled %}checked{% endif %} onchange="toggleGenreFilter()">
                            <div>
                                <label for="genreFilterEnabled" class="checkbox-label main">Enable Genre Filter</label>
                                <div class="checkbox-label description">Filter movies by genre before adding</div>
                            </div>
                        </div>
                        
                        <div id="genreFilterOptions" class="filter-options {% if genre_filter_enabled %}active{% endif %}" style="margin-top: 0.5rem;">
                            <div class="form-group">
                                <label class="form-label">Filter Mode</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="boxarr_features_auto_add_genre_filter_mode" value="whitelist" 
                                               {% if genre_filter_mode == 'whitelist' %}checked{% endif %} onchange="updateGenreMode()">
                                        <span>Whitelist - Only add movies with selected genres</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="boxarr_features_auto_add_genre_filter_mode" value="blacklist" 
                                               {% if genre_filter_mode == 'blacklist' %}checked{% endif %} onchange="updateGenreMode()">
                                        <span>Blacklist - Exclude movies with selected genres</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" id="genreListLabel">
                                    {% if genre_filter_mode == 'whitelist' %}Allowed Genres{% else %}Excluded Genres{% endif %}
                                </label>
                                <div class="genre-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem;">
                                    {% set common_genres = ['Action', 'Adventure', 'Animation', 'Comedy', 'Crime', 'Documentary', 
                                                           'Drama', 'Family', 'Fantasy', 'History', 'Horror', 'Music', 
                                                           'Mystery', 'Romance', 'Science Fiction', 'TV Movie', 'Thriller', 'War', 'Western'] %}
                                    {% for genre in common_genres %}
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" name="genre_{{ genre | replace(' ', '_') }}" value="{{ genre }}"
                                               data-genre-whitelist="{% if genre in genre_whitelist %}true{% else %}false{% endif %}"
                                               data-genre-blacklist="{% if genre in genre_blacklist %}true{% else %}false{% endif %}"
                                               {% if (genre_filter_mode == 'whitelist' and genre in genre_whitelist) or (genre_filter_mode == 'blacklist' and genre in genre_blacklist) %}checked{% endif %}>
                                        <span>{{ genre }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Age Rating Filter -->
                    <div class="filter-section" style="margin-top: 1.5rem;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="ratingFilterEnabled" name="boxarr_features_auto_add_rating_filter_enabled" 
                                   class="checkbox-input" {% if rating_filter_enabled %}checked{% endif %} onchange="toggleRatingFilter()">
                            <div>
                                <label for="ratingFilterEnabled" class="checkbox-label main">Enable Age Rating Filter</label>
                                <div class="checkbox-label description">Only add movies with specific age ratings</div>
                            </div>
                        </div>
                        
                        <div id="ratingFilterOptions" class="filter-options {% if rating_filter_enabled %}active{% endif %}" style="margin-top: 0.5rem;">
                            <div class="form-group">
                                <label class="form-label">Allowed Age Ratings</label>
                                <div class="rating-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem;">
                                    {% set common_ratings = ['G', 'PG', 'PG-13', 'R', 'NC-17', 'NR'] %}
                                    {% for rating in common_ratings %}
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" name="rating_{{ rating | replace('-', '_') }}" value="{{ rating }}"
                                               {% if rating in rating_whitelist %}checked{% endif %}>
                                        <span>{{ rating }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                                <small class="text-muted">Note: Some movies may not have rating information available</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="qualityUpgrade" name="boxarr_features_quality_upgrade" class="checkbox-input"
                           {% if quality_upgrade %}checked{% endif %}>
                    <div>
                        <label for="qualityUpgrade" class="checkbox-label main">Quality Upgrade Buttons</label>
                        <div class="checkbox-label description">Show buttons to upgrade movie quality profiles</div>
                    </div>
                </div>
            </div>

            <!-- Scheduler Debug Section (Collapsible) -->
            {% if is_configured %}
            <div class="form-section scheduler-debug-section">
                <h2 class="section-title collapsible" onclick="toggleSchedulerDebug()">
                    <span class="collapse-icon">▶</span> Scheduler Debug
                    <span id="schedulerStatusBadge" class="status-badge"></span>
                </h2>
                
                <div id="schedulerDebugContent" class="scheduler-debug-content" style="display: none;">
                    <div class="debug-info">
                        <div class="debug-row">
                            <span class="debug-label">Service Status:</span>
                            <span id="debugServiceStatus" class="debug-value">Loading...</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">Next Run:</span>
                            <span id="debugNextRun" class="debug-value">Loading...</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">Last Run:</span>
                            <span id="debugLastRun" class="debug-value">Loading...</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">Active Jobs:</span>
                            <span id="debugActiveJobs" class="debug-value">Loading...</span>
                        </div>
                        <div class="debug-row">
                            <span class="debug-label">Timezone:</span>
                            <span id="debugTimezone" class="debug-value">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="debug-actions">
                        <button type="button" class="btn btn-sm btn-success" onclick="triggerScheduler()">
                            ▶ Trigger Now
                        </button>
                        <button type="button" class="btn btn-sm btn-warning" onclick="reloadScheduler()">
                            🔄 Reload
                        </button>
                        <button type="button" class="btn btn-sm btn-info" onclick="refreshSchedulerStatus()">
                            🔍 Refresh Status
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="button-row">
                {% if is_configured %}
                <a href="/" class="btn btn-secondary">← Back to Dashboard</a>
                {% else %}
                <div id="navigationSection" style="display: none;">
                    <a href="/" class="btn btn-secondary">← Back to Dashboard</a>
                </div>
                {% endif %}
                
                <button type="submit" class="btn btn-primary btn-lg" id="saveBtn" disabled>
                    <span id="saveButtonText">Save Configuration</span>
                    <span id="saveButtonSpinner" class="loading-spinner" style="display: none;"></span>
                </button>
            </div>
            
            <div id="saveMessage"></div>
        </form>
    </div>

<script src="/static/js/app.js?v=2"></script>
</body>
</html>