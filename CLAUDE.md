# Boxarr - Developer Documentation

## What Boxarr Actually Does

Boxarr is a web application that:
1. **Fetches weekly box office data** from Box Office Mojo (top 10 movies)
2. **Auto-adds missing movies** to Radarr with default quality profile
3. **Generates static HTML pages** for each week with beautiful movie cards
4. **Updates status dynamically** via JavaScript polling (only Radarr status/quality changes)
5. **Provides UI-first configuration** - no environment variables required

This transforms a working local script into a shareable, dockerized application.

## Architecture Overview

```
Weekly Scheduler (Tuesday 11 PM)
    ↓
Fetch Box Office Top 10
    ↓
Match with Radarr Library
    ↓
Auto-add Missing Movies
    ↓
Generate Static HTML Page (YYYY/WW.html)
    ↓
JavaScript polls /api/movies/status for dynamic updates
```

**Key Design Decision**: Static HTML generation with minimal dynamic updates (efficient, like the original working system at http://eems:8888/box-office-summary.html)

## Current Implementation

### Core Modules (`src/core/`)
- `boxoffice.py` - Box Office Mojo scraper with BeautifulSoup
- `radarr.py` - Complete Radarr API client
- `matcher.py` - Smart movie matching algorithm (handles sequels, colons, etc.)
- `scheduler.py` - APScheduler that triggers weekly updates
- `html_generator.py` - Generates static HTML pages with compact header and dynamic navigation
- `exceptions.py` - Custom exception hierarchy

### API (`src/api/`)
- `app.py` - FastAPI application with web UI routes

### Utilities (`src/utils/`)
- `config.py` - Pydantic settings management (env vars + YAML)
- `logger.py` - Logging with rotation

### Main Entry Point
- `src/main.py` - Application startup with CLI/API modes

## How It Works

### 1. First Run (Setup Wizard)
```bash
docker run -p 8888:8888 -v ./config:/config boxarr
```
- Visit http://localhost:8888 → redirects to `/setup`
- Enter Radarr URL and API key
- Click "Test Connection" - fetches quality profiles dynamically
- Select options and save → stored in `/config/local.yaml`

### 2. Weekly Update Process
- Scheduler runs (or manual trigger)
- Fetches current box office from Box Office Mojo
- Matches movies with Radarr library
- Auto-adds unmatched movies with default profile
- Generates static HTML at `/config/weekly_pages/YYYYWWW.html`
- Updates `/config/weekly_pages/current.html` symlink

### 3. Dynamic Updates
- Static HTML includes JavaScript
- JS polls `/api/movies/status` every 30 seconds
- Updates only: status (Downloaded/Missing/In Cinemas) and quality profiles
- Everything else stays static (posters, titles, descriptions)

### 4. Quality Upgrades
- "Upgrade to Ultra-HD" button on each movie card
- Calls `/api/movies/{id}/upgrade`
- Updates quality profile in Radarr

## API Endpoints

### Configuration
- `POST /api/config/test` - Test Radarr connection and fetch profiles
- `POST /api/config/save` - Save configuration

### Box Office
- `GET /api/boxoffice/current` - Current week with Radarr matching
- `GET /api/boxoffice/history/{year}/W{week}` - Historical data

### Movies
- `GET /api/movies/{id}` - Movie details
- `POST /api/movies/{id}/upgrade` - Upgrade quality profile
- `POST /api/movies/status` - Batch status check (for JS polling, filters null IDs)
- `POST /api/movies/add` - Manually add a movie to Radarr (with automatic regeneration)

### Weekly Pages Management
- `GET /api/weeks` - Get list of all available weeks with metadata
- `DELETE /api/weeks/{year}/W{week}/delete` - Delete specific week's data files
- `POST /api/update-week` - Update box office for specific historical week

### Web UI
- `GET /` - Current week or redirect to setup
- `GET /setup` - Configuration wizard (with Back to Dashboard button)
- `GET /dashboard` - Browse all weeks (paginated display with delete functionality)
- `GET /{year}W{week}.html` - Specific week's static page

### Utility
- `GET /api/health` - Health check
- `POST /api/trigger-update` - Manual update trigger

## Configuration

### No Environment Variables Required!
Start container without any configuration:
```bash
docker run -p 8888:8888 -v ./config:/config boxarr
```

### Configuration File (`/config/local.yaml`)
Generated by setup wizard:
```yaml
radarr:
  url: http://localhost:7878
  api_key: your-key
  root_folder: /movies
  quality_profile_default: HD-1080p
  quality_profile_upgrade: Ultra-HD

boxarr:
  scheduler:
    enabled: true
    cron: "0 23 * * 2"  # Tuesday 11 PM
  features:
    auto_add: true
    quality_upgrade: true
```

### Optional Environment Variables
Can override config file:
- `RADARR_URL`
- `RADARR_API_KEY`
- `BOXARR_DATA_DIRECTORY` (default: `/config`)

## File Structure

### Generated Files
```
/config/
├── local.yaml              # Configuration (created by setup wizard)
├── weekly_pages/
│   ├── 2024W48.html       # Static page for week 48
│   ├── 2024W48.json       # Metadata with full movie data
│   └── current.html       # Current week page
├── history/                # Historical update results
│   └── YYYYWWW_*.json     # Update history with timestamps
└── logs/                   # Application logs
```

### Metadata JSON Structure
Each week's JSON file contains:
- Basic metadata (year, week, dates)
- Quality profiles from Radarr
- **Full movie data array** including:
  - Box office info (rank, title, gross)
  - Radarr info (if matched)
  - TMDB data (poster, overview, genres)
  - Status and display properties
- This enables regeneration without re-fetching external data

### Source Code
```
src/
├── core/                   # Business logic
├── api/                    # FastAPI application
├── utils/                  # Configuration and logging
├── web/                    # Templates and static files
└── main.py                # Entry point
```

## Testing

### Unit Tests
```bash
pytest tests/unit/test_matcher.py -v
```

### Manual Testing
```bash
# Without Docker
python src/main.py

# With Docker
docker build -t boxarr .
docker run -p 8888:8888 -v ./config:/config boxarr
```

### Test Radarr Connection
```bash
curl -X POST http://localhost:8888/api/config/test \
  -H "Content-Type: application/json" \
  -d '{"url":"http://localhost:7878","api_key":"your-key"}'
```

## Key Implementation Details

### Movie Matching Algorithm
- Normalizes titles (removes punctuation, handles "The")
- Handles sequels (Roman numerals, numbers)
- Special case for "Movie: Subtitle" vs "Movie Subtitle"
- Year matching for disambiguation
- Confidence scoring with configurable threshold

### Static HTML Generation
- **Compact header design** with integrated navigation and connection status
- **Dynamic navigation** that loads available weeks via API
  - Shows 4 most recent weeks as quick links
  - Comprehensive dropdown menu grouped by year
  - Scales efficiently for 100+ weeks
- Beautiful responsive cards (5 per row on 4K)
- Purple gradient theme
- Movie posters with rank badges
- Status indicators with colors
- Quality profile display
- IMDb and Wikipedia links
- JavaScript for dynamic updates

### Dashboard Features
- **Paginated display** - Shows first 24 weeks (6 months)
- **Delete functionality** - Remove individual weeks with confirmation
- **Dropdown navigation** for older weeks beyond the first 24
- **Empty state handling** - Graceful message when no weeks exist

### Auto-Add Logic (When Enabled)
1. Check `settings.boxarr_features_auto_add` setting
2. If enabled:
   - Find unmatched box office movies
   - Search TMDB via Radarr API
   - Add with default quality profile
   - Set as monitored
   - Trigger search
3. If disabled:
   - Log count of unmatched movies
   - Display "Add to Radarr" button in UI
   - Wait for manual user action

### Manual Movie Addition
1. User clicks "Add to Radarr" button
2. Frontend calls `/api/movies/add` endpoint
3. Backend searches TMDB for movie
4. Adds movie with default quality profile
5. Triggers `regenerate_weeks_with_movie()`:
   - Searches all metadata JSON files
   - Finds weeks containing the movie
   - Re-matches with updated Radarr library
   - Regenerates HTML for affected weeks
6. Frontend reloads to show updated status

### TMDB Data Enrichment
For movies NOT in Radarr:
1. Search TMDB via Radarr's search endpoint
2. Extract from first result:
   - Poster URL (`remotePoster`)
   - Year
   - Overview (truncated to 150 chars)
   - Genres (first 2)
   - IMDB ID
3. Store full data in metadata JSON
4. Display in movie cards with same layout as Radarr movies

## Docker Deployment

### Simple Dockerfile
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY src/ /app/src/
VOLUME ["/config"]
EXPOSE 8888
CMD ["python", "-m", "src.main"]
```

### Docker Commands for Development
```bash
# Stop existing container
docker stop boxarr

# Remove container
docker rm boxarr

# Build new image
docker build -t boxarr:test .

# Run container
docker run -d \
    --name boxarr \
    -p 8888:8888 \
    -v $(pwd)/config:/config \
    boxarr:test

# View logs
docker logs -f boxarr
```

### Docker Compose
```yaml
version: '3.8'
services:
  boxarr:
    build: .
    ports:
      - "8888:8888"
    volumes:
      - ./config:/config
    restart: unless-stopped
```

## Performance Considerations

- **Static HTML**: Most content is static, reducing server load
- **Batch API calls**: Status updates fetch all movies at once
- **Caching**: 1-hour cache TTL for box office data
- **Minimal polling**: JS updates every 30 seconds (configurable)
- **Efficient matching**: Indexed movie cache for O(1) lookups

## Security

- **No hardcoded credentials**: Everything via UI or config file
- **API key validation**: Test connection before saving
- **Input sanitization**: All user inputs validated
- **File paths**: Restricted to /config volume
- **No database**: No SQL injection risks

## Future Improvements (Not Implemented)

- Multiple Radarr instance support
- Notifications (Discord, Telegram)
- Advanced scheduling options
- WebSocket for real-time updates
- Vue.js frontend (currently static HTML)
- PostgreSQL support (currently SQLite only)

## GitHub Repository

- **Repository**: https://github.com/iongpt/boxarr
- **Branch**: feature/core-implementation
- **SSH Config**: Uses `github.com-iongpt` host alias with specific key

## License

GNU General Public License v3.0 (GPLv3)

## Important Notes

1. **This is production-ready code** - Clean, tested, documented
2. **UI-first approach** - No pre-configuration needed
3. **Efficient architecture** - Static HTML with minimal dynamic updates
4. **Professional quality** - Ready for public scrutiny
5. **Docker-ready** - Single command deployment

## Known Behaviors & Design Decisions

### Auto-Add Setting
- When **enabled**: Movies are automatically added during scheduled updates
- When **disabled**: Movies show "Add to Radarr" button for manual control
- Setting can be changed at any time via Settings page
- Changes take effect on next update cycle

### Movie Data Persistence
- All movie metadata stored in JSON files
- Enables regeneration without external API calls
- Preserves historical data even if movie removed from Radarr
- TMDB data cached at generation time

### Page Regeneration
- Automatic when movie added to Radarr
- Affects all weeks containing that movie
- Preserves week's original box office rankings
- Updates only the Radarr status and quality info

### Navigation Scalability
- Recent 4 weeks shown as quick links
- Dropdown menu groups weeks by year
- Dashboard shows 24 most recent weeks
- Older weeks accessible via dropdown
- Handles 100+ weeks efficiently